<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üéÅ NFT –ú–∞–≥–∞–∑–∏–Ω</title>
  <style>
    body { font-family:sans-serif; padding:20px; max-width:600px; margin:auto }
    .product { border:1px solid #ccc; padding:10px; margin:10px 0; display:flex }
    img { width:80px; height:80px; margin-right:15px }
    button{padding:5px 10px;}
  </style>
</head>
<body>
  <h1>üéÅ NFT –ú–∞–≥–∞–∑–∏–Ω</h1>
  <div id="products">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
  <div id="history">...</div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();

    let user_id = tg.initDataUnsafe.user?.id || 0;

    function loadProducts() {
      fetch('/products').then(r => r.json()).then(data => {
        let html = data.map(p => `
          <div class="product">
            <img src="${p.image}" />
            <div>
              <b>${p.name}</b><br>–¶–µ–Ω–∞: ${p.price} TON<br>
              <button onclick="buy(${p.id})">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        `).join('');
        document.getElementById('products').innerHTML = html || '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤';
        loadHistory();
      });
    }

    function buy(id) {
      fetch('/purchase', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_id, product_id: id })
      }).then(r => r.json()).then(res => {
        if (res.success) {
          alert('‚úÖ –ö—É–ø–ª–µ–Ω–æ!');
          loadHistory();
        }
      });
    }

    function loadHistory() {
      fetch('/purchases/'+user_id).then(r => r.json()).then(data => {
        document.getElementById('history').innerHTML = data.map(h =>
          `<div>${h.name} ‚Äî ${h.price} TON<br><small>${new Date(h.purchase_date).toLocaleString()}</small></div>`
        ).join('') || '–ü–æ–∫—É–ø–æ–∫ –Ω–µ—Ç';
      });
    }

    loadProducts();
  </script>
</body>
</html>

