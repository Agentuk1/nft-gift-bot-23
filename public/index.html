<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>NFT Магазин</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; }
    .product { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; }
    .product img { width: 80px; height: 80px; margin-right: 15px; }
    button { padding: 5px 10px; }
  </style>
</head>
<body>

<h1>NFT Магазин</h1>
<div id="products"></div>

<h2>История покупок</h2>
<div id="history"></div>

<script>
  const tg = window.Telegram.WebApp;
  const user_id = tg.initDataUnsafe?.user?.id;

  if (!user_id) {
    alert("Ошибка: не удалось получить user_id от Telegram");
    throw new Error("user_id не найден");
  }

  function fetchProducts() {
    fetch('/products').then(res => res.json()).then(data => {
      const container = document.getElementById('products');
      container.innerHTML = '';
      data.forEach(p => {
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" />
          <div>
            <b>${p.name}</b><br />
            Цена: ${p.price} руб.<br />
            <button onclick="buy(${p.id})">Купить</button>
          </div>
        `;
        container.appendChild(div);
      });
    });
  }

  function fetchHistory() {
    fetch(`/purchases/${user_id}`).then(res => res.json()).then(data => {
      const container = document.getElementById('history');
      container.innerHTML = '';
      if (data.length === 0) container.textContent = 'Покупок нет';
      data.forEach(h => {
        const div = document.createElement('div');
        div.textContent = `${h.name} — ${h.price} руб. — ${new Date(h.purchase_date).toLocaleString()}`;
        container.appendChild(div);
      });
    });
  }

  function buy(product_id) {
    fetch('/purchase', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id, product_id })
    }).then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Покупка успешна!');
          fetchHistory();
        } else alert('Ошибка: ' + (data.error || 'Неизвестно'));
      });
  }

  // Инициализация Telegram Web App
  tg.ready();
  fetchProducts();
  fetchHistory();
</script>

</body>
</html>

